# 🧩 GitHub Actions Workflow — ShopHikes
# 🚀 Deploy Next.js (standalone) to Lightsail with PM2
# ✨ Includes pnpm store caching and skips Next lint/type to speed up builds

name: "🚀 Deploy ShopHikes to Lightsail"

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # 🌐 Public (Repository Variables)
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ vars.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}
      NEXT_PUBLIC_SANITY_API_VERSION: ${{ vars.NEXT_PUBLIC_SANITY_API_VERSION }}
      NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}

      # 🔒 Private (Repository Variables)
      SANITY_API_READ_TOKEN: ${{ vars.SANITY_API_READ_TOKEN }}
      SANITY_API_TOKEN: ${{ vars.SANITY_API_TOKEN }}

      # 🧱 Upstash (Repository Variables)
      UPSTASH_REDIS_REST_URL: ${{ vars.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ vars.UPSTASH_REDIS_REST_TOKEN }}

      # 🔑 SSH (Repository Variables)
      SSH_USER: ${{ vars.SSH_USER }}
      SSH_HOST: ${{ vars.SSH_HOST }}
      SSH_PRIVATE_KEY: ${{ vars.SSH_PRIVATE_KEY }}

      # 📦 Deploy target on server
      APP_DIR: ${{ vars.APP_DIR }}

      # 🧪 No telemetry in CI
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      - name: "🔍 Checkout"
        uses: actions/checkout@v4

      - name: "📦 Setup PNPM"
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0
          run_install: false

      - name: "🟢 Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: "🗃️ Cache pnpm store"
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: "📥 Install dependencies"
        run: pnpm install --frozen-lockfile

      - name: "⚡ Cache Next.js build cache"
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('next.config.*', 'tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-

      - name: "🧼 Sanitize build env + assert"
        shell: bash
        run: |
          set -euo pipefail
          strip(){ v="$1"; v="${v//\"/}"; v="${v//\'/}"; v="${v// /}"; printf '%s' "$v"; }

          # Public env used at build-time
          echo "NEXT_PUBLIC_SANITY_PROJECT_ID=$(strip "${NEXT_PUBLIC_SANITY_PROJECT_ID:-}")" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SANITY_DATASET=$(strip "${NEXT_PUBLIC_SANITY_DATASET:-}")"       >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SANITY_API_VERSION=$(strip "${NEXT_PUBLIC_SANITY_API_VERSION:-2025-10-28}")" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_BASE_URL=$(strip "${NEXT_PUBLIC_BASE_URL:-}")"                   >> "$GITHUB_ENV"

          # Private/Server env also exported for build in case code reads them during build
          echo "SANITY_API_READ_TOKEN=$(strip "${SANITY_API_READ_TOKEN:-}")"                 >> "$GITHUB_ENV"
          echo "SANITY_API_TOKEN=$(strip "${SANITY_API_TOKEN:-}")"                           >> "$GITHUB_ENV"
          echo "UPSTASH_REDIS_REST_URL=$(strip "${UPSTASH_REDIS_REST_URL:-}")"               >> "$GITHUB_ENV"
          echo "UPSTASH_REDIS_REST_TOKEN=$(strip "${UPSTASH_REDIS_REST_TOKEN:-}")"           >> "$GITHUB_ENV"

          # Required assertions for public env
          : "${NEXT_PUBLIC_SANITY_PROJECT_ID:?Missing NEXT_PUBLIC_SANITY_PROJECT_ID}"
          : "${NEXT_PUBLIC_SANITY_DATASET:?Missing NEXT_PUBLIC_SANITY_DATASET}"

      - name: "🏗️ Build (standalone, fast)"
        env:
          NEXT_DISABLE_ESLINT: 1
          NEXT_DISABLE_TYPECHECK: 1
        run: pnpm run build

      - name: "📦 Package standalone"
        shell: bash
        run: |
          set -euo pipefail
          test -f ".next/standalone/server.js" || { echo "Missing .next/standalone/server.js"; exit 1; }
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          rm -rf out && mkdir -p out
          cp -r .next/standalone out/standalone
          cp -r .next/static out/standalone/.next/static
          if [ -d public ]; then cp -r public out/standalone/public; fi
          tar -C out -czf "shophikes_${SHORT_SHA}.tar.gz" standalone

      - name: "🔐 Setup SSH"
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o BatchMode=yes "$SSH_USER@$SSH_HOST" true

      - name: "🧾 Create ecosystem.config.js"
        shell: bash
        run: |
          set -euo pipefail
          : > ecosystem.config.js
          echo 'module.exports = {' >> ecosystem.config.js
          echo '  apps: [' >> ecosystem.config.js
          echo '    {' >> ecosystem.config.js
          echo '      name: "shophikes",' >> ecosystem.config.js
          echo '      cwd: "/home/bitnami/htdocs/Ecommerce-with-sanity/current",' >> ecosystem.config.js
          echo '      script: "standalone/server.js",' >> ecosystem.config.js
          echo '      instances: 1,' >> ecosystem.config.js
          echo '      exec_mode: "cluster",' >> ecosystem.config.js
          echo '      env: {' >> ecosystem.config.js
          echo '        PORT: 3005,' >> ecosystem.config.js
          echo '        NODE_ENV: "production",' >> ecosystem.config.js
          echo '        SANITY_API_READ_TOKEN: "__SANITY_API_READ_TOKEN__",' >> ecosystem.config.js
          echo '        SANITY_API_TOKEN: "__SANITY_API_TOKEN__",' >> ecosystem.config.js
          echo '        UPSTASH_REDIS_REST_URL: "__UPSTASH_REDIS_REST_URL__",' >> ecosystem.config.js
          echo '        UPSTASH_REDIS_REST_TOKEN: "__UPSTASH_REDIS_REST_TOKEN__"' >> ecosystem.config.js
          echo '      }' >> ecosystem.config.js
          echo '    }' >> ecosystem.config.js
          echo '  ]' >> ecosystem.config.js
          echo '}' >> ecosystem.config.js

          # Safely escape and substitute secrets into the file
          esc() { printf "%s" "${1:-}" | sed -e 's/[\/&]/\\&/g'; }
          READ_ESC=$(esc "${SANITY_API_READ_TOKEN:-}")
          WRITE_ESC=$(esc "${SANITY_API_TOKEN:-}")
          UPSTASH_URL_ESC=$(esc "${UPSTASH_REDIS_REST_URL:-}")
          UPSTASH_TOKEN_ESC=$(esc "${UPSTASH_REDIS_REST_TOKEN:-}")

          sed -i "s/__SANITY_API_READ_TOKEN__/${READ_ESC}/g" ecosystem.config.js
          sed -i "s/__SANITY_API_TOKEN__/${WRITE_ESC}/g"     ecosystem.config.js
          sed -i "s/__UPSTASH_REDIS_REST_URL__/${UPSTASH_URL_ESC}/g" ecosystem.config.js
          sed -i "s/__UPSTASH_REDIS_REST_TOKEN__/${UPSTASH_TOKEN_ESC}/g" ecosystem.config.js

      - name: "⬆️ Upload artifact + ecosystem"
        run: |
          scp -i ~/.ssh/id_rsa "shophikes_${SHORT_SHA}.tar.gz" "$SSH_USER@$SSH_HOST:/tmp/"
          scp -i ~/.ssh/id_rsa ecosystem.config.js            "$SSH_USER@$SSH_HOST:/tmp/"

      - name: "🚀 Activate release + PM2 start"
        run: |
          ssh -i ~/.ssh/id_rsa "$SSH_USER@$SSH_HOST" "
            set -euo pipefail
            RELEASES_DIR='${APP_DIR}/releases'
            CURRENT_LINK='${APP_DIR}/current'
            NEW_RELEASE_DIR=\"\$RELEASES_DIR/${SHORT_SHA}\"
            mkdir -p \"\$RELEASES_DIR\" '${APP_DIR}'/logs
            rm -rf \"\$NEW_RELEASE_DIR\" && mkdir -p \"\$NEW_RELEASE_DIR\"
            tar -xzf \"/tmp/shophikes_${SHORT_SHA}.tar.gz\" -C \"\$NEW_RELEASE_DIR\"
            rm -f \"/tmp/shophikes_${SHORT_SHA}.tar.gz\"
            ln -sfn \"\$NEW_RELEASE_DIR\" \"\$CURRENT_LINK\"
            if ! command -v pm2 >/dev/null 2>&1; then npm i -g pm2; fi
            mv /tmp/ecosystem.config.js '${APP_DIR}'/ecosystem.config.js
            pm2 delete shophikes >/dev/null 2>&1 || true
            pm2 start '${APP_DIR}'/ecosystem.config.js --only shophikes
            pm2 save
            # Optional: print env to logs for verification (redacts values length)
            echo 'PM2 env keys:'; pm2 env shophikes | sed -n 's/^$$SANITY_API_READ_TOKEN\|SANITY_API_TOKEN\|UPSTASH_REDIS_REST_URL\|UPSTASH_REDIS_REST_TOKEN$$=.*/\1=***redacted***/p'
          "
